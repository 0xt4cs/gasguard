<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - GasGuard</title>
    <link rel="icon" type="image/png" href="assets/images/gasguard.png">
    <link rel="stylesheet" href="assets/css/output.css">
    <script src="assets/js/socket.io.min.js"></script>
    <style>
        .collapse > input[type="checkbox"] {
            width: 0;
            height: 0;
            position: absolute;
            left: -9999px;
        }
        
        @media (max-width: 768px) {
            .table th, .table td {
                padding: 0.5rem;
                font-size: 0.875rem;
            }
            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }
    </style>
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
</head>
<body class="min-h-screen overflow-x-hidden">
    <div class="drawer">
        <input id="main-drawer" type="checkbox" class="drawer-toggle" />
        
        <!-- Main Content -->
        <div class="drawer-content flex flex-col">
            <!-- Navbar -->
            <div class="navbar bg-base-100 border-b-2 border-base-300 shadow-sm">
                <div class="navbar-start">
                    <label for="main-drawer" class="btn btn-square btn-ghost drawer-button">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </label>
                    <div class="flex items-center gap-3 ml-2">
                        <div class="avatar">
                            <div class="w-10 rounded">
                                <img src="assets/images/gasguard.png" alt="GasGuard Logo" />
                            </div>
                        </div>
                        <div class="hidden sm:block">
                            <h1 class="text-xl font-bold">GasGuard</h1>
                            <p class="text-xs text-base-content/70">Settings</p>
                        </div>
                    </div>
                </div>
                <div class="navbar-end gap-2">
                    <div class="text-sm text-base-content/70 hidden md:block" id="current-time"></div>
                    
                    <!-- Login Button  -->
                    <button id="login-btn" class="btn btn-warning btn-sm gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                        </svg>
                        <span class="hidden sm:inline">Login</span>
                    </button>
                    
                    <!-- User Dropdown -->
                    <div id="user-dropdown" class="dropdown dropdown-end hidden">
                        <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar flex items-center justify-center p-0">
                            <div class="w-10 h-10 rounded-full bg-primary text-primary-content flex items-center justify-center font-bold text-base" id="user-avatar">
                                <span id="user-avatar-letter" class="flex items-center justify-center w-full h-full"></span>
                            </div>
                        </div>
                        <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-64 max-w-[calc(100vw-2rem)] p-2 shadow-lg border border-base-300 mt-2 right-0" style="background-color: hsl(var(--b1)) !important;">
                            <li class="menu-title p-3 border-b border-base-300">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-full bg-primary text-primary-content flex items-center justify-center font-bold text-lg" id="user-dropdown-avatar">
                                        <span id="user-dropdown-avatar-letter"></span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="font-semibold text-base-content" id="user-dropdown-username"></span>
                                        <span class="text-xs text-base-content/70" id="user-dropdown-role"></span>
                                    </div>
                                </div>
                            </li>
                            <li class="p-2">
                                <label for="theme-toggle-dropdown" class="flex items-center justify-between w-full cursor-pointer">
                                    <div class="flex flex-col">
                                        <span class="text-sm font-medium text-base-content">Theme</span>
                                        <span class="text-xs text-base-content/60" id="theme-status">Light Mode</span>
                                    </div>
                                    <div class="swap swap-rotate">
                                        <input type="checkbox" id="theme-toggle-dropdown" />
                                        <svg class="swap-on w-5 h-5 fill-current" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                                        </svg>
                                        <svg class="swap-off w-5 h-5 fill-current" viewBox="0 0 20 20">
                                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                                        </svg>
                                    </div>
                                </label>
                            </li>
                            <li>
                                <button id="logout-btn-dropdown" class="btn btn-error btn-sm w-full gap-2 justify-start">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    Logout
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

    <!-- Login Modal -->
    <dialog id="login-modal" class="modal">
        <div class="modal-box max-w-md p-0 overflow-hidden">
            <!-- Close Button -->
            <form method="dialog">
                <button class="btn btn-sm btn-circle absolute right-4 top-4 z-10 bg-base-100 border-0 hover:bg-error hover:text-error-content shadow-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </form>
            
            <!-- Header Section -->
            <div class="bg-base-100 pt-12 pb-6 text-center">
                <h3 class="text-2xl font-bold mb-1">Welcome!</h3>
                <p class="text-base-content/60 text-sm">Sign in for full access</p>
            </div>
            
            <!-- Form Section -->
            <div class="p-8 pt-4">
                <form id="login-form" class="space-y-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Username</span>
                        </label>
                        <input type="text" id="username" name="username" class="input input-bordered w-full" placeholder="Enter username" required autocomplete="username" />
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Password</span>
                        </label>
                        <input type="password" id="password" name="password" class="input input-bordered w-full" placeholder="Enter password" required autocomplete="current-password" />
                    </div>

                    <div id="login-error" class="hidden alert alert-error">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Invalid credentials. Please try again.</span>
                    </div>

                    <button type="submit" class="btn btn-warning w-full gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                        </svg>
                        Sign In
                    </button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

            <!-- Main Content -->
            <main class="flex-1 w-full">
                <div class="w-full px-4 sm:px-6 lg:px-8 py-4 sm:py-6 lg:py-8">
                    <!-- Breadcrumbs -->
                    <div class="text-sm breadcrumbs mb-6">
                        <ul>
                            <li><a href="/">Dashboard</a></li>
                            <li>Settings</li>
                        </ul>
                    </div>

                <h1 class="text-3xl font-bold mb-6">Settings</h1>

                <!-- Loading Overlay -->
                <div id="loading-overlay" class="hidden fixed inset-0 bg-base-300/50 flex items-center justify-center z-50">
                    <span class="loading loading-spinner loading-lg"></span>
                </div>

                <!-- Account Security Section -->
                <section class="card bg-base-100 shadow-xl mb-6">
                    <div class="card-body">
                        <h3 class="card-title text-lg font-bold flex items-center gap-2">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>
                            Account Security
                        </h3>
                        <p class="text-sm text-base-content/70">Change your account password</p>
                        <div class="divider"></div>
                        
                        <form id="password-form" class="space-y-4">
                            <!-- User Selection (Admin Only) -->
                            <div id="user-selection-section" class="form-control hidden">
                                <label class="label">
                                    <span class="label-text font-semibold">Select User Account</span>
                                </label>
                                <div class="flex gap-4">
                                    <label class="label cursor-pointer gap-2">
                                        <input type="radio" name="target-user" value="admin" class="radio radio-warning" checked />
                                        <span class="label-text">Admin Account</span>
                                    </label>
                                    <label class="label cursor-pointer gap-2">
                                        <input type="radio" name="target-user" value="user" class="radio radio-warning" />
                                        <span class="label-text">User Account</span>
                                    </label>
                                </div>
                                <label class="label">
                                    <span class="label-text-alt text-warning">You are changing the password for the selected account</span>
                                </label>
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Current Password</span>
                                    <span class="label-text-alt text-base-content/60" id="password-help-text">Enter current password of selected account</span>
                                </label>
                                <input type="password" id="current-password" placeholder="Enter current password" class="input input-bordered w-full" required />
                            </div>
                            
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">New Password</span>
                                </label>
                                <input type="password" id="new-password" placeholder="Enter new password (min 8 characters)" class="input input-bordered w-full" required minlength="8" />
                            </div>
                            
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Confirm New Password</span>
                                </label>
                                <input type="password" id="confirm-password" placeholder="Confirm new password" class="input input-bordered w-full" required minlength="8" />
                            </div>
                            
                            <div id="password-error" class="alert alert-error hidden">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                                <span id="password-error-text"></span>
                            </div>
                            
                            <div id="password-success" class="alert alert-success hidden">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                                <span>Password changed successfully!</span>
                            </div>
                            
                            <button type="submit" class="btn btn-warning">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>
                                Change Password
                            </button>
                        </form>
                    </div>
                </section>

                <!-- WiFi Network Management Section (Admin Only) -->
                <section id="wifi-section" class="card bg-base-100 shadow-xl mb-6">
                    <div class="card-body">
                        <h3 class="card-title text-lg font-bold flex items-center gap-2">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M2 5.5a2.5 2.5 0 012.5-2.5h11a2.5 2.5 0 010 5h-11A2.5 2.5 0 012 5.5zM4.5 5a.5.5 0 100 1 .5.5 0 000-1zM8 5a.5.5 0 100 1 .5.5 0 000-1zM11.5 5a.5.5 0 100 1 .5.5 0 000-1z M2 13.5A2.5 2.5 0 014.5 11h11a2.5 2.5 0 010 5h-11A2.5 2.5 0 012 13.5zM4.5 13a.5.5 0 100 1 .5.5 0 000-1zM8 13a.5.5 0 100 1 .5.5 0 000-1zM11.5 13a.5.5 0 100 1 .5.5 0 000-1z"></path></svg>
                            WiFi Network Management
                        </h3>
                        <p class="text-sm text-base-content/70">Configure WiFi connection</p>
                        <div class="divider"></div>
                        
                        <!-- Access Point Banner -->
                        <div class="alert alert-success mb-4">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M17.778 8.222c-4.296-4.296-11.26-4.296-15.556 0A1 1 0 01.808 6.808c5.076-5.077 13.308-5.077 18.384 0a1 1 0 01-1.414 1.414zM14.95 11.05a7 7 0 00-9.9 0 1 1 0 01-1.414-1.414 9 9 0 0112.728 0 1 1 0 01-1.414 1.414zM12.12 13.88a3 3 0 00-4.242 0 1 1 0 01-1.415-1.415 5 5 0 017.072 0 1 1 0 01-1.415 1.415zM9 16a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z"></path></svg>
                            <div class="flex-1">
                                <div class="font-semibold">WiFi Access Point Active</div>
                                <div class="text-sm opacity-90">
                                    <strong>SSID:</strong> GasGuard-AP  |  
                                    <strong>Password:</strong> GGL34kD3t3ct  |  
                                    <strong>IP:</strong> 192.168.4.1
                                </div>
                                <div class="text-xs opacity-75 mt-1">
                                    The device creates a WiFi hotspot that's always available for local access
                                </div>
                            </div>
                        </div>
                        
                        <!-- Current Connection Status -->
                        <div class="alert mb-4" id="wifi-status-alert">
                            <div class="flex items-center gap-2">
                                <svg class="w-6 h-6" id="wifi-status-icon" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M17.778 8.222c-4.296-4.296-11.26-4.296-15.556 0A1 1 0 01.808 6.808c5.076-5.077 13.308-5.077 18.384 0a1 1 0 01-1.414 1.414zM14.95 11.05a7 7 0 00-9.9 0 1 1 0 01-1.414-1.414 9 9 0 0112.728 0 1 1 0 01-1.414 1.414zM12.12 13.88a3 3 0 00-4.242 0 1 1 0 01-1.415-1.415 5 5 0 017.072 0 1 1 0 01-1.415 1.415zM9 16a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z"></path>
                                </svg>
                                <div class="flex-1">
                                    <div class="font-semibold" id="wifi-status-text">Checking WiFi status...</div>
                                    <div class="text-sm opacity-70" id="wifi-status-details"></div>
                                </div>
                                <button class="btn btn-sm btn-outline btn-error hidden" id="wifi-disconnect-btn" onclick="disconnectWiFi()">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                                    Disconnect
                                </button>
                            </div>
                        </div>

                        <!-- Available Networks -->
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-semibold">Available Networks</h4>
                                <button class="btn btn-sm btn-warning gap-2" id="wifi-scan-btn" onclick="scanWiFiNetworks()">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
                                    <span id="wifi-scan-text">Scan</span>
                                </button>
                            </div>
                            
                            <div class="overflow-x-auto w-full">
                                <table class="table table-zebra w-full">
                                    <thead>
                                        <tr>
                                            <th class="whitespace-nowrap">Network Name (SSID)</th>
                                            <th class="text-center whitespace-nowrap">Signal</th>
                                            <th class="text-center whitespace-nowrap">Security</th>
                                            <th class="text-center whitespace-nowrap">Frequency</th>
                                            <th class="text-center whitespace-nowrap">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="wifi-networks-table">
                                        <tr>
                                            <td colspan="5" class="text-center text-base-content/50 py-8">
                                                <svg class="w-10 h-10 mx-auto mb-2 opacity-50" fill="currentColor" viewBox="0 0 20 20"><path d="M17.778 8.222c-4.296-4.296-11.26-4.296-15.556 0A1 1 0 01.808 6.808c5.076-5.077 13.308-5.077 18.384 0a1 1 0 01-1.414 1.414zM14.95 11.05a7 7 0 00-9.9 0 1 1 0 01-1.414-1.414 9 9 0 0112.728 0 1 1 0 01-1.414 1.414zM12.12 13.88a3 3 0 00-4.242 0 1 1 0 01-1.415-1.415 5 5 0 017.072 0 1 1 0 01-1.415 1.415zM9 16a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z"></path></svg>
                                                <div class="font-semibold">No networks scanned yet</div>
                                                <div class="text-xs mt-1">Click "Scan" to find available WiFi networks</div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Help Text -->
                        <div class="alert alert-info mt-4">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                            <div class="text-sm">
                                <strong>Note:</strong> Changes to WiFi settings require administrator privileges. 
                                The system will need to restart for changes to take effect.
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Profile & Location Section -->
                <section class="card bg-base-100 shadow-xl mb-6">
                    <div class="card-body">
                        <h3 class="card-title text-lg font-bold flex items-center gap-2">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                            Profile & Location
                        </h3>
                        <p class="text-sm text-base-content/70">Configure your personal information and location for SMS alerts</p>
                        <div class="divider"></div>
                        
                        <form id="profile-form" class="space-y-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Full Name / House Resident</span>
                                </label>
                                <input type="text" id="full-name" placeholder="e.g., Juan Dela Cruz" class="input input-bordered w-full" />
                            </div>
                            
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Phone Number</span>
                                </label>
                                <input type="tel" id="phone" placeholder="e.g., +63 912 345 6789" class="input input-bordered w-full" />
                                <label class="label">
                                    <span class="label-text-alt">This will be included in SMS alerts</span>
                                </label>
                            </div>
                            
                            <!-- Manual Location -->
                            <div id="manual-location-fields" class="space-y-4">
                                <div class="alert alert-info">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                                    <span class="text-sm">Manual location is used because GPS is disabled. Enable GPS in "GPS Settings" below to use automatic coordinates.</span>
                                </div>
                                
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Address</span>
                                    </label>
                                    <input type="text" id="address" placeholder="e.g., 123 Main St, Quezon City" class="input input-bordered w-full" />
                                </div>
                                
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Landmark</span>
                                    </label>
                                    <input type="text" id="landmark" placeholder="e.g., Near SM Mall" class="input input-bordered w-full" />
                                </div>
                            </div>
                            
                            <div id="profile-success" class="alert alert-success hidden">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                                <span>Profile updated successfully!</span>
                            </div>
                            
                            <button type="submit" class="btn btn-warning">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z"></path></svg>
                                Save Profile
                            </button>
                        </form>
                    </div>
                </section>

                <!-- GPS Settings Section -->
                <section class="card bg-base-100 shadow-xl mb-6">
                    <div class="card-body">
                        <h3 class="card-title text-lg font-bold flex items-center gap-2">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path></svg>
                            GPS Settings
                        </h3>
                        <p class="text-sm text-base-content/70">Choose location source for SMS alerts</p>
                        <div class="divider"></div>
                        
                        <form id="gps-form" class="space-y-4">
                            <div class="alert alert-warning">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                                <div>
                                    <div class="font-bold">Location Source</div>
                                    <div class="text-sm">When enabled, GPS coordinates with Google Maps link will be sent. When disabled, manual address from Profile will be used.</div>
                                </div>
                            </div>
                            
                            <div class="form-control">
                                <label class="label cursor-pointer justify-start gap-4">
                                    <input type="checkbox" id="gps-enabled" class="toggle toggle-primary toggle-lg" />
                                    <div>
                                        <span class="label-text font-bold text-base">Use GPS Coordinates</span>
                                        <p class="text-xs text-base-content/70 mt-1">Send real-time GPS location (lat/long + Google Maps link) in SMS alerts</p>
                                    </div>
                                </label>
                            </div>
                            
                            <div class="stats shadow w-full">
                                <div class="stat">
                                    <div class="stat-title">Current GPS Status</div>
                                    <div class="stat-value text-sm" id="gps-status-settings">Checking...</div>
                                    <div class="stat-desc" id="gps-coords-settings">â€”</div>
                                </div>
                            </div>
                            
                            <div id="gps-success" class="alert alert-success hidden">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                                <span>GPS settings updated!</span>
                            </div>
                            
                            <button type="submit" class="btn btn-warning">
                                <svg class="w-5 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z"></path></svg>
                                Save GPS Settings
                            </button>
                        </form>
                    </div>
                </section>

                <!-- Alert Preferences Section (Admin Only) -->
                <section id="admin-alert-preferences" class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h3 class="card-title text-lg font-bold flex items-center gap-2">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path id="secondary" d="M15,17H9a1,1,0,0,0-1,1,4,4,0,0,0,8,0A1,1,0,0,0,15,17Z"></path>
                                <path id="primary" d="M21,17H20V10A8,8,0,0,0,4,10v7H3a1,1,0,0,0,0,2H21a1,1,0,0,0,0-2Z" style="fill: currentColor;"></path>
                            </svg>
                            Alert Preferences
                        </h3>
                        <p class="text-sm text-base-content/70">Configure notification and alert thresholds</p>
                        <div class="divider"></div>
                        
                        <form id="alerts-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Low Level Threshold (PPM)</span>
                                    </label>
                                    <input type="number" id="low-threshold" placeholder="300" class="input input-bordered w-full" min="100" max="1000" />
                                </div>
                                
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Critical Level Threshold (PPM)</span>
                                    </label>
                                    <input type="number" id="critical-threshold" placeholder="800" class="input input-bordered w-full" min="100" max="1000" />
                                </div>
                            </div>
                            
                            <div class="divider">Buzzer Options</div>
                            
                            <div class="form-control">
                                <label class="label cursor-pointer">
                                    <span class="label-text">Buzzer on Low Level</span>
                                    <input type="checkbox" id="buzz-low" class="toggle toggle-primary" />
                                </label>
                            </div>
                            
                            <div class="form-control">
                                <label class="label cursor-pointer">
                                    <span class="label-text">Buzzer on Critical Level</span>
                                    <input type="checkbox" id="buzz-critical" class="toggle toggle-primary" />
                                </label>
                            </div>
                            
                            <div id="alerts-success" class="alert alert-success hidden">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                                <span>Alert preferences updated!</span>
                            </div>
                            
                            <button type="submit" class="btn btn-warning">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z"></path></svg>
                                Save Alert Settings
                            </button>
                        </form>
                    </div>
                </section>

                <!-- SMS Alert Configuration Section -->
                <section id="admin-sms-config" class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h3 class="card-title text-lg font-bold flex items-center gap-2">
                            <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M17 3.5H7C4 3.5 2 5 2 8.5V15.5C2 19 4 20.5 7 20.5H17C20 20.5 22 19 22 15.5V8.5C22 5 20 3.5 17 3.5ZM17.47 9.59L14.34 12.09C13.68 12.62 12.84 12.88 12 12.88C11.16 12.88 10.31 12.62 9.66 12.09L6.53 9.59C6.21 9.33 6.16 8.85 6.41 8.53C6.67 8.21 7.14 8.15 7.46 8.41L10.59 10.91C11.35 11.52 12.64 11.52 13.4 10.91L16.53 8.41C16.85 8.15 17.33 8.2 17.58 8.53C17.84 8.85 17.79 9.33 17.47 9.59Z"/>
                            </svg>
                            SMS Alert Configuration
                        </h3>
                        <p class="text-sm text-base-content/70">Configure FREE SMS alerts using your Android phone as gateway</p>
                        <div class="divider"></div>

                        <!-- SMS Toggle -->
                        <div class="form-control">
                            <label class="label cursor-pointer">
                                <div class="flex flex-col items-start">
                                    <span class="label-text font-semibold">Enable SMS Alerts</span>
                                    <span class="label-text-alt text-base-content/60">Receive SMS notifications when gas is detected</span>
                                </div>
                                <input type="checkbox" id="sms-alerts-toggle" class="toggle toggle-warning toggle-lg" />
                            </label>
                        </div>

                        <!-- SMS Toggle Status -->
                        <div id="sms-toggle-success" class="alert alert-success hidden mt-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                            <span id="sms-toggle-success-text">SMS alerts enabled</span>
                        </div>

                        <div id="sms-toggle-error" class="alert alert-error hidden mt-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                            <span id="sms-toggle-error-text">Error toggling SMS alerts</span>
                        </div>

                        <!-- TextBee Configuration -->
                        <div id="textbee-config-section" class="hidden mt-4">
                            <!-- Setup Instructions -->
                            <div class="bg-base-200 rounded-lg p-4 mb-4">
                                <h4 class="font-semibold text-sm mb-3 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
                                    Quick Setup Guide
                                </h4>
                                <ol class="text-sm space-y-2 list-decimal list-inside text-base-content/70">
                                    <li>1. Register at <strong>textbee.dev</strong></li>
                                    <li>2. Download and install the Android app</li>
                                    <li>3. Generate API Key from dashboard</li>
                                    <li>4. Scan QR code in app to register your device</li>
                                    <li>5. Copy API Key and Device ID below</li>
                                </ol>
                            </div>

                            <form id="textbee-config-form" class="space-y-4">
                                <!-- API Key -->
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text font-semibold">TextBee API Key</span>
                                        <span class="label-text-alt">
                                            <a href="https://textbee.dev/dashboard" target="_blank" class="link link-primary text-xs">Get from Dashboard</a>
                                        </span>
                                    </label>
                                    <input 
                                        type="text" 
                                        id="textbee-api-key" 
                                        placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" 
                                        class="input input-bordered w-full font-mono text-sm" 
                                    />
                                    <label class="label">
                                        <span class="label-text-alt">Your unique API key from TextBee dashboard</span>
                                    </label>
                                </div>

                                <!-- Device ID -->
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text font-semibold">Device ID</span>
                                        <span class="label-text-alt text-xs">From TextBee</span>
                                    </label>
                                    <input 
                                        type="text" 
                                        id="textbee-device-id" 
                                        placeholder="Enter your device ID from the app" 
                                        class="input input-bordered w-full font-mono text-sm" 
                                    />
                                    <label class="label">
                                        <span class="label-text-alt">Your phone's device ID after registration</span>
                                    </label>
                                </div>

                                <!-- Test SMS Section -->
                                <div class="divider">Test Configuration</div>

                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text font-semibold">Test Phone Number</span>
                                    </label>
                                    <div class="join w-full">
                                        <input type="tel" id="test-phone-number" placeholder="+639171234567" class="input input-bordered join-item flex-1 font-mono text-sm" />
                                        <button type="button" onclick="sendTestSMS()" class="btn btn-warning join-item">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path></svg>
                                            Send Test SMS
                                        </button>
                                    </div>
                                    <label class="label">
                                        <span class="label-text-alt">Format: +[country][number] (e.g., +639171234567 for Philippines)</span>
                                    </label>
                                </div>

                                <!-- Success/Error Messages -->
                                <div id="textbee-success" class="alert alert-success hidden">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                                    <span id="textbee-success-text">Configuration saved!</span>
                                </div>

                                <div id="textbee-error" class="alert alert-error hidden">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                                    <span id="textbee-error-text">Error message</span>
                                </div>

                                <!-- Save Button -->
                                <button type="submit" class="btn btn-warning">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z"></path></svg>
                                    Save TextBee Configuration
                                </button>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- Data Management Section (Admin Only) -->
                <section id="admin-data-management" class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h3 class="card-title text-lg font-bold flex items-center gap-2">
                            <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            Data Management
                        </h3>
                        <p class="text-sm text-base-content/70">Configure data retention policy and manage historical data</p>
                        <div class="divider"></div>

                        <!-- Data Retention Period -->
                        <div class="form-control mb-4">
                            <label class="label">
                                <span class="label-text font-semibold">Data Retention Period</span>
                                <span class="label-text-alt text-base-content/60">How long to keep data</span>
                            </label>
                            <select id="retention-period" class="select select-bordered w-full">
                                <option value="30">30 Days (1 Month)</option>
                                <option value="90" selected>90 Days (3 Months) - Default</option>
                                <option value="180">180 Days (6 Months)</option>
                                <option value="365">365 Days (1 Year)</option>
                                <option value="-1">Never (Keep All Data)</option>
                            </select>
                            <label class="label">
                                <span class="label-text-alt" id="retention-description">Data older than the selected period will be automatically deleted</span>
                            </label>
                        </div>

                        <!-- Retention Save Button -->
                        <button onclick="saveRetentionPeriod()" class="btn btn-warning mb-4">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z"></path>
                            </svg>
                            Save Retention Setting
                        </button>

                        <div id="retention-success" class="alert alert-success hidden mb-4">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <span>Retention period updated successfully!</span>
                        </div>

                        <div class="divider">Current Data Statistics</div>

                        <!-- Data Statistics Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="stat bg-base-200 rounded-lg">
                                <div class="stat-title">Sensor Readings</div>
                                <div class="stat-value text-2xl" id="stat-sensor-count">-</div>
                                <div class="stat-desc" id="stat-sensor-range">Loading...</div>
                            </div>
                            <div class="stat bg-base-200 rounded-lg">
                                <div class="stat-title">Alerts</div>
                                <div class="stat-value text-2xl" id="stat-alert-count">-</div>
                                <div class="stat-desc" id="stat-alert-range">Loading...</div>
                            </div>
                            <div class="stat bg-base-200 rounded-lg">
                                <div class="stat-title">System Logs</div>
                                <div class="stat-value text-2xl" id="stat-log-count">-</div>
                                <div class="stat-desc" id="stat-log-range">Loading...</div>
                            </div>
                        </div>

                        <div class="divider">Manual Data Deletion</div>

                        <!-- Warning Banner -->
                        <div class="alert alert-warning mb-4">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            <div>
                                <div class="font-bold">Danger Zone</div>
                                <div class="text-sm">Manual deletion will permanently remove historical data older than 7 days. This action cannot be undone!</div>
                            </div>
                        </div>

                        <!-- Manual Delete Button -->
                        <button onclick="openDeleteModal()" class="btn btn-error">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            Delete All Historical Data
                        </button>
                    </div>
                </section>
            
    <!-- Delete Data Confirmation Modal -->
    <dialog id="delete-data-modal" class="modal">
        <div class="modal-box max-w-2xl">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
            </form>
            <h3 class="font-bold text-xl mb-4 text-error flex items-center gap-2">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                Delete All Historical Data
            </h3>
            
            <div class="alert alert-error mb-4">
                <span>This action will permanently delete:</span>
            </div>

            <div class="stats stats-vertical lg:stats-horizontal shadow mb-4 w-full">
                <div class="stat">
                    <div class="stat-title">Sensor Readings</div>
                    <div class="stat-value text-2xl" id="delete-sensor-count">-</div>
                </div>
                <div class="stat">
                    <div class="stat-title">Alerts</div>
                    <div class="stat-value text-2xl" id="delete-alert-count">-</div>
                </div>
                <div class="stat">
                    <div class="stat-title">System Logs</div>
                    <div class="stat-value text-2xl" id="delete-log-count">-</div>
                </div>
            </div>

            <div class="bg-base-200 p-4 rounded-lg mb-4">
                <p class="text-sm mb-2"><strong>Safety:</strong> Data from the last 7 days will be preserved</p>
                <p class="text-sm mb-2"><strong>Impact:</strong> This will free up database space</p>
                <p class="text-sm"><strong>Security:</strong> Auth logs will be preserved</p>
            </div>

            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text font-semibold">Type <span class="text-error">DELETE ALL DATA</span> to confirm:</span>
                </label>
                <input 
                    type="text" 
                    id="delete-confirmation-input" 
                    placeholder="DELETE ALL DATA" 
                    class="input input-bordered w-full font-mono"
                    autocomplete="off"
                />
            </div>

            <div class="form-control mb-4">
                <label class="label cursor-pointer justify-start gap-2">
                    <input type="checkbox" id="delete-understand-checkbox" class="checkbox checkbox-error" />
                    <span class="label-text">I understand this action cannot be undone</span>
                </label>
            </div>

            <div id="delete-error" class="alert alert-error hidden mb-4">
                <span id="delete-error-text">Error message</span>
            </div>

            <div class="modal-action">
                <button onclick="closeDeleteModal()" class="btn">Cancel</button>
                <button onclick="confirmDeleteData()" class="btn btn-error" id="confirm-delete-btn" disabled>
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    Yes, Delete Everything
                </button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Confirmation Modal -->
    <dialog id="confirm-modal" class="modal">
        <div class="modal-box">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </form>
            <h3 class="font-bold text-lg mb-4">Confirm Action</h3>
            <p class="mb-4" id="confirm-message">Are you sure you want to proceed?</p>
            <div class="modal-action">
                <button onclick="cancelAction()" class="btn">Cancel</button>
                <button onclick="confirmAction()" class="btn btn-warning" id="confirm-btn">Confirm</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- WiFi Connection Modal -->
    <dialog id="wifi-connect-modal" class="modal">
        <div class="modal-box">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </form>
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M17.778 8.222c-4.296-4.296-11.26-4.296-15.556 0A1 1 0 01.808 6.808c5.076-5.077 13.308-5.077 18.384 0a1 1 0 01-1.414 1.414zM14.95 11.05a7 7 0 00-9.9 0 1 1 0 01-1.414-1.414 9 9 0 0112.728 0 1 1 0 01-1.414 1.414zM12.12 13.88a3 3 0 00-4.242 0 1 1 0 01-1.415-1.415 5 5 0 017.072 0 1 1 0 01-1.415 1.415zM9 16a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z"></path></svg>
                Connect to WiFi
            </h3>
            
            <form id="wifi-connect-form" class="space-y-4">
                <div class="alert alert-info">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                    <div class="text-sm">
                        <strong>Network:</strong> <span id="connect-ssid-display" class="font-mono">â€”</span>
                    </div>
                </div>

                <input type="hidden" id="connect-ssid" />
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">WiFi Password</span>
                    </label>
                    <div class="relative">
                        <input type="password" id="wifi-password" placeholder="Enter network password" class="input input-bordered w-full pr-12" required minlength="8" />
                        <button type="button" class="btn btn-ghost btn-sm btn-circle absolute right-2 top-1/2 -translate-y-1/2" onclick="togglePasswordVisibility()">
                            <svg class="w-5 h-5" id="eye-icon-open" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>
                            <svg class="w-5 h-5 hidden" id="eye-icon-closed" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 2.003 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z" clip-rule="evenodd"></path><path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.741L2.335 6.578A9.98 9.98 0 00.458 10c1.274 4.057 5.065 7 9.542 7 .847 0 1.669-.105 2.454-.303z"></path></svg>
                        </button>
                    </div>
                    <label class="label">
                        <span class="label-text-alt">Minimum 8 characters required</span>
                    </label>
                </div>

                <div id="wifi-connect-error" class="alert alert-error hidden">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                    <span id="wifi-connect-error-text"></span>
                </div>

                <div class="modal-action">
                    <button type="button" onclick="document.getElementById('wifi-connect-modal').close()" class="btn btn-ghost">Cancel</button>
                    <button type="submit" class="btn btn-warning gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.778 8.222c-4.296-4.296-11.26-4.296-15.556 0A1 1 0 01.808 6.808c5.076-5.077 13.308-5.077 18.384 0a1 1 0 01-1.414 1.414zM14.95 11.05a7 7 0 00-9.9 0 1 1 0 01-1.414-1.414 9 9 0 0112.728 0 1 1 0 01-1.414 1.414zM12.12 13.88a3 3 0 00-4.242 0 1 1 0 01-1.415-1.415 5 5 0 017.072 0 1 1 0 01-1.415 1.415zM9 16a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z"></path></svg>
                        Connect
                    </button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>
                </div>
            </main>
        </div>
        <!-- End of drawer-content -->

        <!-- Drawer Side -->
        <div class="drawer-side z-10">
            <label for="main-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
            <aside class="bg-base-200 min-h-screen w-80 p-4">
                <!-- Sidebar Header -->
                <div class="flex items-center gap-3 px-4 py-6 border-b border-base-300">
                    <div class="avatar">
                        <div class="w-12 rounded-lg">
                            <img src="assets/images/gasguard.png" alt="GasGuard Logo" />
                        </div>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold">GasGuard</h2>
                        <p class="text-xs text-base-content/70">IoT Gas Leak Detection</p>
                    </div>
                </div>

                <!-- Navigation Menu -->
                <ul class="menu p-0 mt-4 text-base">
                    <li>
                        <a href="/" class="py-4 px-6 text-base">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M1 2.25C1 1.56 1.56 1 2.25 1h3.5C6.44 1 7 1.56 7 2.25v11.5C7 14.44 6.44 15 5.75 15h-3.5C1.56 15 1 14.44 1 13.75V2.25zm1.5.25v11h3v-11h-3zM9 2.25C9 1.56 9.56 1 10.25 1h3.5c.69 0 1.25.56 1.25 1.25v3.5C15 6.44 14.44 7 13.75 7h-3.5C9.56 7 9 6.44 9 5.75v-3.5zm1.5.25v3h3v-3h-3zM10.25 9C9.56 9 9 9.56 9 10.25v3.5c0 .69.56 1.25 1.25 1.25h3.5c.69 0 1.25-.56 1.25-1.25v-3.5C15 9.56 14.44 9 13.75 9h-3.5zm.25 4.5v-3h3v3h-3z"/>
                            </svg>
                            Dashboard
                        </a>
                    </li>
                    <li class="user-only hidden">
                        <a href="/settings.html" class="py-4 px-6 text-base">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
                            </svg>
                            Settings
                        </a>
                    </li>
                    <li class="user-only hidden">
                        <a href="/contacts.html" class="py-4 px-6 text-base">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 15 15">
                                <path d="M2 12.5V13H3V12.5H2ZM7 12.5V13H8V12.5H7ZM3 12.5V11.9999H2V12.5H3ZM7 11.9997V12.5H8V11.9997H7ZM5 10C6.10466 10 7 10.8952 7 11.9997H8C8 10.3427 6.65677 9 5 9V10ZM3 11.9999C3 10.8953 3.8954 10 5 10V9C3.34318 9 2 10.343 2 11.9999H3ZM5 4C3.89543 4 3 4.89543 3 6H4C4 5.44772 4.44772 5 5 5V4ZM7 6C7 4.89543 6.10457 4 5 4V5C5.55228 5 6 5.44772 6 6H7ZM5 8C6.10457 8 7 7.10457 7 6H6C6 6.55228 5.55228 7 5 7V8ZM5 7C4.44772 7 4 6.55228 4 6H3C3 7.10457 3.89543 8 5 8V7ZM1.5 3H13.5V2H1.5V3ZM14 3.5V11.5H15V3.5H14ZM13.5 12H1.5V13H13.5V12ZM1 11.5V3.5H0V11.5H1ZM1.5 12C1.22386 12 1 11.7761 1 11.5H0C0 12.3284 0.671574 13 1.5 13V12ZM14 11.5C14 11.7761 13.7761 12 13.5 12V13C14.3284 13 15 12.3284 15 11.5H14ZM13.5 3C13.7761 3 14 3.22386 14 3.5H15C15 2.67157 14.3284 2 13.5 2V3ZM1.5 2C0.671573 2 0 2.67157 0 3.5H1C1 3.22386 1.22386 3 1.5 3V2ZM9 6H12V5H9V6ZM9 9H12V8H9V9ZM0 15H15V14H0V15ZM3 0V2.5H4V0H3ZM11 0V2.5H12V0H11Z"/>
                            </svg>
                            Alert Contacts
                        </a>
                    </li>
                    <li class="user-only hidden">
                        <a href="/history.html" class="py-4 px-6 text-base">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12,24C5.4,24,0,18.6,0,12h2c0,5.5,4.5,10,10,10s10-4.5,10-10S17.5,2,12,2C8.4,2,5.1,3.9,3.3,7H8v2H0V1h2v4.4 C4.2,2.1,8,0,12,0c6.6,0,12,5.4,12,12S18.6,24,12,24z M15.3,17.8L11,13.4V6h2v6.6l3.7,3.8L15.3,17.8z"/>
                            </svg>
                            History & Statistics
                        </a>
                    </li>
                    <li class="admin-only hidden">
                        <a href="/admin/calibration.html" class="py-4 px-6 text-base">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 8v11h12V8h-3V2h2v4h5v2h-2v12a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V8H2V6h5V2h2v6H6zm7-6v6h-2V2h2z"/>
                            </svg>
                            Sensor Calibration
                        </a>
                    </li>
                    <li class="admin-only hidden">
                        <a href="/admin/system-logs.html" class="py-4 px-6 text-base">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 48 48">
                                <path d="M24 43.9998H8V3.99977H40V23.9998" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                                <path d="M35.5 43.9998V30.9998" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                                <path d="M31 34.4998L32.5 32.9998L35.5 29.9998L38.5 32.9998L40 34.4998" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                                <path d="M16 15.9998H32" stroke="currentColor" stroke-width="4" stroke-linecap="round" fill="none"/>
                                <path d="M16 23.9998H24" stroke="currentColor" stroke-width="4" stroke-linecap="round" fill="none"/>
                            </svg>
                            System Logs
                        </a>
                    </li>
                </ul>

                <!-- Sidebar Footer -->
                <div class="absolute bottom-4 left-4 right-4">
                    <div class="divider"></div>
                    <div class="text-xs text-center text-base-content/50">
                        <p>GasGuard v1.0.0</p>
                        <p class="mt-1">IoT Gas Leak Detection System</p>
                    </div>
                </div>
            </aside>
        </div>
        <!-- End of drawer-side -->
    </div>
    <!-- End of drawer -->

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/modals.js"></script>
    <script src="/assets/js/nav.js"></script>
    <script>
        (function() {
            'use strict';

            const API_BASE = '/api';
            let currentSettings = null;

            // Show loading
            const showLoading = () => {
                const overlay = document.getElementById('loading-overlay');
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            };
            const hideLoading = () => {
                const overlay = document.getElementById('loading-overlay');
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            };

            // Show success message
            const showSuccess = (elementId) => {
                const el = document.getElementById(elementId);
                el.classList.remove('hidden');
                setTimeout(() => el.classList.add('hidden'), 3000);
            };

            // Show error
            const showError = (message) => {
                const errorEl = document.getElementById('password-error');
                const errorText = document.getElementById('password-error-text');
                errorText.textContent = message;
                errorEl.classList.remove('hidden');
                setTimeout(() => errorEl.classList.add('hidden'), 5000);
            };

            // Load settings from API
            async function loadSettings() {
                const token = getToken();
                if (!token) return;

                try {
                    showLoading();
                    const response = await fetch(`${API_BASE}/settings`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) throw new Error('Failed to load settings');

                    const data = await response.json();
                    currentSettings = data.settings;
                    populateForm();
                } catch (error) {
                    console.error('Load settings error:', error);
                    showToast('Failed to load settings: ' + error.message, 'error');
                } finally {
                    hideLoading();
                }
            }

            // Populate form
            function populateForm() {
                if (!currentSettings) return;

                // Profile
                if (currentSettings.profile) {
                    document.getElementById('full-name').value = currentSettings.profile.fullName || '';
                    document.getElementById('phone').value = currentSettings.profile.phone || '';
                    document.getElementById('address').value = currentSettings.profile.address || '';
                    document.getElementById('landmark').value = currentSettings.profile.landmark || '';
                }

                // GPS
                if (currentSettings.gps) {
                    document.getElementById('gps-enabled').checked = currentSettings.gps.enabled || false;
                    updateGPSDisplay(currentSettings.gps);
                    toggleManualLocationFields();
                }

                // Alerts
                if (currentSettings.alerts) {
                    const lowThreshold = document.getElementById('low-threshold');
                    const criticalThreshold = document.getElementById('critical-threshold');
                    const buzzLow = document.getElementById('buzz-low');
                    const buzzCritical = document.getElementById('buzz-critical');
                    
                    if (lowThreshold) lowThreshold.value = currentSettings.alerts.lowLevelThreshold || 300;
                    if (criticalThreshold) criticalThreshold.value = currentSettings.alerts.criticalLevelThreshold || 800;
                    if (buzzLow) buzzLow.checked = currentSettings.alerts.buzzOnLow !== undefined ? currentSettings.alerts.buzzOnLow : true;
                    if (buzzCritical) buzzCritical.checked = currentSettings.alerts.buzzOnCritical !== undefined ? currentSettings.alerts.buzzOnCritical : true;
                }
            }

            // Toggle manual location fields based on GPS toggle
            function toggleManualLocationFields() {
                const gpsEnabled = document.getElementById('gps-enabled').checked;
                const manualFields = document.getElementById('manual-location-fields');
                
                if (gpsEnabled) {
                    manualFields.classList.add('hidden');
                } else {
                    manualFields.classList.remove('hidden');
                }
            }
            
            // Update GPS display
            function updateGPSDisplay(gpsData) {
                const statusEl = document.getElementById('gps-status-settings');
                const coordsEl = document.getElementById('gps-coords-settings');
                
                if (gpsData.enabled && gpsData.latitude && gpsData.longitude) {
                    statusEl.textContent = 'GPS Enabled';
                    statusEl.classList.add('text-success');
                    coordsEl.textContent = `${gpsData.latitude.toFixed(6)}, ${gpsData.longitude.toFixed(6)}`;
                } else if (gpsData.enabled) {
                    statusEl.textContent = 'Searching for signal...';
                    statusEl.classList.add('text-warning');
                    coordsEl.textContent = 'Waiting for GPS fix';
                } else {
                    statusEl.textContent = 'GPS Disabled';
                    statusEl.classList.remove('text-success', 'text-warning');
                    coordsEl.textContent = 'Manual address will be used';
                }
            }
            
            // GPS toggle event listener
            document.getElementById('gps-enabled').addEventListener('change', toggleManualLocationFields);
            
            // WebSocket connection
            const socket = io();
            
            socket.on('connect', () => {
                console.log('Connected to server');
            });
            
            socket.on('hardware-status', (data) => {
                if (data.gpsData) {
                    updateGPSDisplayRealtime(data.gpsData);
                }
            });
            
            socket.on('gps-update', (gpsData) => {
                updateGPSDisplayRealtime(gpsData);
            });
            
            // Update GPS display
            function updateGPSDisplayRealtime(gpsData) {
                const statusEl = document.getElementById('gps-status-settings');
                const coordsEl = document.getElementById('gps-coords-settings');
                
                if (gpsData.latitude && gpsData.longitude) {
                    statusEl.textContent = 'Located';
                    statusEl.className = 'stat-value text-sm text-success';
                    coordsEl.textContent = `${gpsData.latitude.toFixed(6)}, ${gpsData.longitude.toFixed(6)}`;
                    if (gpsData.satellites) {
                        coordsEl.textContent += ` (${gpsData.satellites} sats)`;
                    }
                } else if (gpsData.satellites > 0) {
                    statusEl.textContent = `Acquiring (${gpsData.satellites} sats)`;
                    statusEl.className = 'stat-value text-sm text-warning';
                    coordsEl.textContent = 'Getting fix...';
                } else if (gpsData.lastKnownLocation && gpsData.lastKnownLocation.latitude) {
                    statusEl.textContent = 'Last Known';
                    statusEl.className = 'stat-value text-sm text-warning';
                    coordsEl.textContent = `${gpsData.lastKnownLocation.latitude.toFixed(6)}, ${gpsData.lastKnownLocation.longitude.toFixed(6)}`;
                    if (gpsData.locationAge) {
                        coordsEl.textContent += ` (${gpsData.locationAge})`;
                    }
                } else if (gpsData.connected === false) {
                    statusEl.textContent = 'No Connection';
                    statusEl.className = 'stat-value text-sm text-error';
                    coordsEl.textContent = 'GPS hardware not available';
                } else {
                    statusEl.textContent = 'Searching for signal...';
                    statusEl.className = 'stat-value text-sm text-warning';
                    coordsEl.textContent = 'Waiting for GPS fix';
                }
            }

            // Password Change Form
            document.getElementById('password-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;

                // Validate
                if (newPassword !== confirmPassword) {
                    showError('New passwords do not match');
                    return;
                }

                if (newPassword.length < 8) {
                    showError('Password must be at least 8 characters');
                    return;
                }

                const token = getToken();
                if (!token) {
                    showError('Please login first');
                    return;
                }

                // Get target username (admin only)
                let targetUsername = null;
                const userSelectionSection = document.getElementById('user-selection-section');
                if (!userSelectionSection.classList.contains('hidden')) {
                    const selectedRadio = document.querySelector('input[name="target-user"]:checked');
                    targetUsername = selectedRadio ? selectedRadio.value : null;
                }

                try {
                    showLoading();
                    const response = await fetch(`${API_BASE}/auth/change-password`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ 
                            currentPassword, 
                            newPassword,
                            targetUsername 
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to change password');
                    }

                    // Success
                    showSuccess('password-success');
                    document.getElementById('password-form').reset();
                    
                    // Reset radio to admin if visible
                    if (!userSelectionSection.classList.contains('hidden')) {
                        document.querySelector('input[name="target-user"][value="admin"]').checked = true;
                    }
                } catch (error) {
                    showError(error.message);
                } finally {
                    hideLoading();
                }
            });

            // Update password help text when user selection changes (Admin only)
            document.querySelectorAll('input[name="target-user"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const passwordHelpText = document.getElementById('password-help-text');
                    const selectedUser = this.value;
                    
                    if (passwordHelpText) {
                        passwordHelpText.textContent = `Enter current password of ${selectedUser} account`;
                    }
                });
            });

            // Profile Form
            document.getElementById('profile-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const token = getToken();
                if (!token) {
                    showToast('Please login first');
                    return;
                }

                const profileData = {
                    fullName: document.getElementById('full-name').value,
                    phone: document.getElementById('phone').value,
                    address: document.getElementById('address').value,
                    landmark: document.getElementById('landmark').value
                };

                try {
                    showLoading();
                    const response = await fetch(`${API_BASE}/settings/profile`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(profileData)
                    });

                    if (!response.ok) throw new Error('Failed to update profile');

                    const data = await response.json();
                    showSuccess('profile-success');
                    
                    // Update current settings
                    if (currentSettings) {
                        currentSettings.profile = data.profile;
                    }
                } catch (error) {
                    showToast('Error: ' + error.message);
                } finally {
                    hideLoading();
                }
            });

            // GPS Form
            document.getElementById('gps-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const token = getToken();
                if (!token) {
                    showToast('Please login first');
                    return;
                }

                const gpsData = {
                    enabled: document.getElementById('gps-enabled').checked
                };

                try {
                    showLoading();
                    const response = await fetch(`${API_BASE}/settings/gps`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(gpsData)
                    });

                    if (!response.ok) throw new Error('Failed to update GPS settings');

                    const data = await response.json();
                    showSuccess('gps-success');
                    
                    // Update current settings
                    if (currentSettings) {
                        currentSettings.gps = data.gps;
                        updateGPSDisplay(data.gps);
                    }
                } catch (error) {
                    showToast('Error: ' + error.message);
                } finally {
                    hideLoading();
                }
            });

            // Alerts Form
            document.getElementById('alerts-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const token = getToken();
                if (!token) {
                    showToast('Please login first');
                    return;
                }

                const alertsData = {
                    lowLevelThreshold: parseInt(document.getElementById('low-threshold').value),
                    criticalLevelThreshold: parseInt(document.getElementById('critical-threshold').value),
                    smsEnabled: document.getElementById('sms-alerts-toggle').checked,
                    buzzOnLow: document.getElementById('buzz-low').checked,
                    buzzOnCritical: document.getElementById('buzz-critical').checked
                };

                try {
                    showLoading();
                    const response = await fetch(`${API_BASE}/settings/alerts`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(alertsData)
                    });

                    if (!response.ok) throw new Error('Failed to update alert settings');

                    const data = await response.json();
                    showSuccess('alerts-success');
                    
                    // Update current settings
                    if (currentSettings) {
                        currentSettings.alerts = data.alerts;
                    }
                } catch (error) {
                    showToast('Error: ' + error.message);
                } finally {
                    hideLoading();
                }
            });

            // SMS Alerts Toggle - Show/Hide TextBee Configuration AND Save Immediately
            document.getElementById('sms-alerts-toggle').addEventListener('change', async function() {
                const configSection = document.getElementById('textbee-config-section');
                const isEnabled = this.checked;
                
                // Show/Hide configuration section
                if (isEnabled) {
                    configSection.classList.remove('hidden');
                } else {
                    configSection.classList.add('hidden');
                }

                // Save the toggle state immediately
                const token = getToken();
                if (!token) {
                    showToast('Please login first');
                    return;
                }

                try {
                    // Hide previous messages
                    document.getElementById('sms-toggle-success').classList.add('hidden');
                    document.getElementById('sms-toggle-error').classList.add('hidden');

                    const response = await fetch(`${API_BASE}/settings/sms-config`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            enabled: isEnabled,
                            apiKey: document.getElementById('textbee-api-key')?.value || '',
                            deviceId: document.getElementById('textbee-device-id')?.value || ''
                        })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        const successEl = document.getElementById('sms-toggle-success');
                        const successText = document.getElementById('sms-toggle-success-text');
                        successText.textContent = isEnabled ? 'SMS alerts enabled successfully' : 'SMS alerts disabled successfully';
                        successEl.classList.remove('hidden');
                        
                        // Auto-hide after 3 seconds
                        setTimeout(() => {
                            successEl.classList.add('hidden');
                        }, 3000);
                    } else {
                        throw new Error(result.error || 'Failed to update SMS alert setting');
                    }
                } catch (error) {
                    console.error('Error saving SMS toggle:', error);
                    const errorEl = document.getElementById('sms-toggle-error');
                    const errorText = document.getElementById('sms-toggle-error-text');
                    errorText.textContent = error.message;
                    errorEl.classList.remove('hidden');
                    
                    // Revert toggle on error
                    this.checked = !isEnabled;
                    
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        errorEl.classList.add('hidden');
                    }, 5000);
                }
            });

            // TextBee Configuration Form
            document.getElementById('textbee-config-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const token = getToken();
                if (!token) {
                    showToast('Please login first');
                    return;
                }

                const textbeeConfig = {
                    enabled: document.getElementById('sms-alerts-toggle').checked,
                    apiKey: document.getElementById('textbee-api-key').value.trim(),
                    deviceId: document.getElementById('textbee-device-id').value.trim()
                };

                // Validation
                if (textbeeConfig.enabled) {
                    if (!textbeeConfig.apiKey) {
                        showTextbeeError('API Key is required');
                        return;
                    }
                    if (!textbeeConfig.deviceId) {
                        showTextbeeError('Device ID is required');
                        return;
                    }
                }

                try {
                    showLoading();
                    const response = await fetch(`${API_BASE}/settings/sms-config`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(textbeeConfig)
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to update SMS configuration');
                    }

                    // Show success with warning if present
                    if (data.warning) {
                        showTextbeeSuccess('Configuration saved! Warning: ' + data.warning);
                    } else {
                        showTextbeeSuccess('TextBee SMS configuration saved successfully!');
                    }
                    
                } catch (error) {
                    showTextbeeError('Error: ' + error.message);
                } finally {
                    hideLoading();
                }
            });

            // Send Test SMS Function
            window.sendTestSMS = async function() {
                const token = getToken();
                if (!token) {
                    showToast('Please login first');
                    return;
                }

                const testPhone = document.getElementById('test-phone-number').value.trim();
                
                if (!testPhone) {
                    showTextbeeError('Please enter a test phone number');
                    return;
                }

                try {
                    showLoading();
                    const response = await fetch(`${API_BASE}/settings/sms-test`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ testPhoneNumber: testPhone })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to send test SMS');
                    }

                    showTextbeeSuccess('Test SMS sent successfully! Check your phone.');
                } catch (error) {
                    showTextbeeError('Error: ' + error.message);
                } finally {
                    hideLoading();
                }
            };

            // Load SMS Configuration
            async function loadSMSConfig() {
                try {
                    const token = getToken();
                    if (!token) return;

                    const response = await fetch(`${API_BASE}/settings/sms-config`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) return;

                    const data = await response.json();
                    const config = data.smsConfig;

                    // Set toggle state
                    document.getElementById('sms-alerts-toggle').checked = config.enabled;
                    
                    // Show/hide config section
                    const configSection = document.getElementById('textbee-config-section');
                    if (config.enabled) {
                        configSection.classList.remove('hidden');
                    } else {
                        configSection.classList.add('hidden');
                    }

                    // Populate TextBee fields
                    document.getElementById('textbee-api-key').value = config.apiKey || '';
                    document.getElementById('textbee-device-id').value = config.deviceId || '';
                } catch (error) {
                    console.error('Load SMS config error:', error);
                }
            }

            // Show TextBee Success Message
            function showTextbeeSuccess(message) {
                const successEl = document.getElementById('textbee-success');
                const textEl = document.getElementById('textbee-success-text');
                const errorEl = document.getElementById('textbee-error');
                
                errorEl.classList.add('hidden');
                textEl.textContent = message;
                successEl.classList.remove('hidden');
                
                setTimeout(() => {
                    successEl.classList.add('hidden');
                }, 5000);
            }

            // Show TextBee Error Message
            function showTextbeeError(message) {
                const successEl = document.getElementById('textbee-success');
                const errorEl = document.getElementById('textbee-error');
                const textEl = document.getElementById('textbee-error-text');
                
                successEl.classList.add('hidden');
                textEl.textContent = message;
                errorEl.classList.remove('hidden');
                
                setTimeout(() => {
                    errorEl.classList.add('hidden');
                }, 5000);
            }

            // Check user role and apply access control
            function applyRoleBasedAccess() {
                const user = window.getUser();
                const wifiSection = document.getElementById('wifi-section');
                const alertPreferences = document.getElementById('admin-alert-preferences');
                const smsConfig = document.getElementById('admin-sms-config');
                const dataManagement = document.getElementById('admin-data-management');
                const userSelectionSection = document.getElementById('user-selection-section');
                const passwordHelpText = document.getElementById('password-help-text');
                
                // Show user selection for admin, hide for regular users
                if (user && user.role === 'admin') {
                    if (userSelectionSection) {
                        userSelectionSection.classList.remove('hidden');
                    }
                } else {
                    if (userSelectionSection) {
                        userSelectionSection.classList.add('hidden');
                    }
                    if (passwordHelpText) {
                        passwordHelpText.textContent = 'Enter your current password';
                    }
                }
                
                // Hide sections if user is not admin
                if (!user || user.role !== 'admin') {
                    if (wifiSection) {
                        wifiSection.style.display = 'none';
                    }
                    if (alertPreferences) {
                        alertPreferences.style.display = 'none';
                    }
                    if (smsConfig) {
                        smsConfig.style.display = 'none';
                    }
                    if (dataManagement) {
                        dataManagement.style.display = 'none';
                    }
                }
            }

            // Load data retention settings
            async function loadRetentionSettings() {
                try {
                    const token = getToken();
                    if (!token) return;

                    const response = await fetch(`${API_BASE}/settings/data-retention`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('retention-period').value = data.retentionDays;
                        updateRetentionDescription(data.retentionDays);
                    }
                } catch (error) {
                    console.error('Error loading retention settings:', error);
                }
            }

            // Update retention description text
            function updateRetentionDescription(days) {
                const desc = document.getElementById('retention-description');
                if (days === -1) {
                    desc.textContent = 'All data will be kept indefinitely. No automatic deletion.';
                    desc.classList.add('text-warning');
                } else {
                    desc.textContent = `Data older than ${days} days will be automatically deleted`;
                    desc.classList.remove('text-warning');
                }
            }

            // Save retention period
            window.saveRetentionPeriod = async function() {
                const token = getToken();
                if (!token) {
                    showToast('Please login first');
                    return;
                }

                const retentionSelect = document.getElementById('retention-period');
                if (!retentionSelect) return;

                const retentionDays = parseInt(retentionSelect.value);

                try {
                    showLoading();
                    const response = await fetch(`${API_BASE}/settings/data-retention`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ retentionDays })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to update retention period');
                    }

                    // Show success message
                    const successEl = document.getElementById('retention-success');
                    if (successEl) {
                        successEl.classList.remove('hidden');
                        setTimeout(() => successEl.classList.add('hidden'), 3000);
                    }

                    updateRetentionDescription(retentionDays);
                } catch (error) {
                    showToast('Error: ' + error.message);
                } finally {
                    hideLoading();
                }
            }

            // Load data statistics
            async function loadDataStatistics() {
                try {
                    const token = getToken();
                    if (!token) return;

                    const response = await fetch(`${API_BASE}/settings/data-statistics`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        updateStatistics(data.statistics);
                    }
                } catch (error) {
                    console.error('Error loading data statistics:', error);
                }
            }

            // Update statistics display
            function updateStatistics(stats) {
                // Sensor data
                document.getElementById('stat-sensor-count').textContent = stats.sensorData.count.toLocaleString();
                if (stats.sensorData.oldest) {
                    const oldestDate = new Date(stats.sensorData.oldest);
                    const newestDate = new Date(stats.sensorData.newest);
                    document.getElementById('stat-sensor-range').textContent = 
                        `${oldestDate.toLocaleDateString()} - ${newestDate.toLocaleDateString()}`;
                } else {
                    document.getElementById('stat-sensor-range').textContent = 'No data';
                }

                // Alerts
                document.getElementById('stat-alert-count').textContent = stats.alerts.count.toLocaleString();
                if (stats.alerts.oldest) {
                    const oldestDate = new Date(stats.alerts.oldest);
                    const newestDate = new Date(stats.alerts.newest);
                    document.getElementById('stat-alert-range').textContent = 
                        `${oldestDate.toLocaleDateString()} - ${newestDate.toLocaleDateString()}`;
                } else {
                    document.getElementById('stat-alert-range').textContent = 'No data';
                }

                // System logs
                document.getElementById('stat-log-count').textContent = stats.systemLogs.count.toLocaleString();
                if (stats.systemLogs.oldest) {
                    const oldestDate = new Date(stats.systemLogs.oldest);
                    const newestDate = new Date(stats.systemLogs.newest);
                    document.getElementById('stat-log-range').textContent = 
                        `${oldestDate.toLocaleDateString()} - ${newestDate.toLocaleDateString()}`;
                } else {
                    document.getElementById('stat-log-range').textContent = 'No data';
                }

                // Update delete modal stats (subtract last 7 days estimate)
                const sevenDaysEstimate = Math.floor(stats.sensorData.count * 0.1); // Rough estimate
                document.getElementById('delete-sensor-count').textContent = Math.max(0, stats.sensorData.count - sevenDaysEstimate).toLocaleString();
                document.getElementById('delete-alert-count').textContent = Math.max(0, stats.alerts.count - Math.floor(stats.alerts.count * 0.1)).toLocaleString();
                document.getElementById('delete-log-count').textContent = Math.max(0, stats.systemLogs.count - Math.floor(stats.systemLogs.count * 0.1)).toLocaleString();
            }

            // Open delete confirmation modal
            window.openDeleteModal = function() {
                const modal = document.getElementById('delete-data-modal');
                const input = document.getElementById('delete-confirmation-input');
                const checkbox = document.getElementById('delete-understand-checkbox');
                const btn = document.getElementById('confirm-delete-btn');

                // Reset inputs
                if (input) input.value = '';
                if (checkbox) checkbox.checked = false;
                if (btn) btn.disabled = true;

                // Hide error
                const errorEl = document.getElementById('delete-error');
                if (errorEl) errorEl.classList.add('hidden');

                // Reload statistics
                loadDataStatistics();

                if (modal) modal.showModal();
            }

            // Close delete modal
            window.closeDeleteModal = function() {
                const modal = document.getElementById('delete-data-modal');
                if (modal) modal.close();
            }

            // Enable delete button when conditions are met
            document.addEventListener('DOMContentLoaded', () => {
                const input = document.getElementById('delete-confirmation-input');
                const checkbox = document.getElementById('delete-understand-checkbox');
                const btn = document.getElementById('confirm-delete-btn');

                function checkDeleteConditions() {
                    const textMatch = input && input.value === 'DELETE ALL DATA';
                    const checkboxChecked = checkbox && checkbox.checked;
                    if (btn) {
                        btn.disabled = !(textMatch && checkboxChecked);
                    }
                }

                if (input) input.addEventListener('input', checkDeleteConditions);
                if (checkbox) checkbox.addEventListener('change', checkDeleteConditions);
            });

            // Confirm and execute data deletion
            window.confirmDeleteData = async function() {
                const token = getToken();
                if (!token) {
                    showToast('Please login first');
                    return;
                }

                const input = document.getElementById('delete-confirmation-input');
                if (!input || input.value !== 'DELETE ALL DATA') {
                    showDeleteError('Confirmation text does not match');
                    return;
                }

                try {
                    showLoading();
                    const response = await fetch(`${API_BASE}/settings/delete-all-data`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ confirmation: 'DELETE ALL DATA' })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to delete data');
                    }

                    // Success!
                    closeDeleteModal();
                    showToast(`Successfully deleted ${data.deleted.total.toLocaleString()} records!`);
                    
                    // Reload statistics
                    loadDataStatistics();
                } catch (error) {
                    showDeleteError(error.message);
                } finally {
                    hideLoading();
                }
            }

            // Show delete error
            function showDeleteError(message) {
                const errorEl = document.getElementById('delete-error');
                const textEl = document.getElementById('delete-error-text');
                textEl.textContent = message;
                errorEl.classList.remove('hidden');
            }

            // Listen for retention period changes
            document.addEventListener('DOMContentLoaded', () => {
                const retentionSelect = document.getElementById('retention-period');
                if (retentionSelect) {
                    retentionSelect.addEventListener('change', function() {
                        updateRetentionDescription(parseInt(this.value));
                    });
                }
            });

            // Load settings on page load (load immediately, no delays)
            window.addEventListener('load', () => {
                applyRoleBasedAccess();
                
                // Load all settings in parallel
                Promise.all([
                    loadSettings(),
                    loadSMSConfig(),
                    loadRetentionSettings(),
                    loadDataStatistics()
                ]).catch(err => {
                    console.error('[ERROR] Failed to load settings:', err);
                });
                
                // Load WiFi status for admins
                const user = window.getUser();
                if (user && user.role === 'admin') {
                    loadWiFiStatus();
                }
            });

            // WiFi Management Functions
            
            // Get signal strength
            function getSignalBadge(signal) {
                const quality = Math.min(Math.max(2 * (signal + 100), 0), 100);
                let badgeClass = 'badge-error';
                let icon = 'â–‚';
                
                if (quality >= 75) {
                    badgeClass = 'badge-success';
                    icon = 'â–‚â–„â–†â–ˆ';
                } else if (quality >= 50) {
                    badgeClass = 'badge-warning';
                    icon = 'â–‚â–„â–†';
                } else if (quality >= 25) {
                    badgeClass = 'badge-warning';
                    icon = 'â–‚â–„';
                }
                
                return `<span class="badge ${badgeClass} badge-sm w-20 justify-center font-mono">${icon} ${quality}%</span>`;
            }

            // Load WiFi status
            window.loadWiFiStatus = async function() {
                try {
                    const token = getToken();
                    if (!token) return;

                    const response = await fetch(`${API_BASE}/wifi/status`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) throw new Error('Failed to load WiFi status');

                    const data = await response.json();
                    const status = data.status;

                    const statusAlert = document.getElementById('wifi-status-alert');
                    const statusText = document.getElementById('wifi-status-text');
                    const statusDetails = document.getElementById('wifi-status-details');
                    const disconnectBtn = document.getElementById('wifi-disconnect-btn');

                    if (status.connected) {
                        statusAlert.className = 'alert alert-success mb-4';
                        statusText.textContent = `Connected to ${status.ssid}`;
                        statusDetails.textContent = `IP Address: ${status.ip} â€¢ Mode: Station`;
                        disconnectBtn.classList.remove('hidden');
                    } else if (status.mode === 'ap') {
                        statusAlert.className = 'alert alert-info mb-4';
                        statusText.textContent = 'Access Point Mode Active';
                        statusDetails.textContent = `Connected clients: ${status.apClients} â€¢ Broadcast SSID: GasLeakDetector`;
                        disconnectBtn.classList.add('hidden');
                    } else {
                        statusAlert.className = 'alert alert-warning mb-4';
                        statusText.textContent = 'Not Connected';
                        statusDetails.textContent = 'Click "Scan" to find available WiFi networks';
                        disconnectBtn.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Load WiFi status error:', error);
                    document.getElementById('wifi-status-text').textContent = 'Error loading WiFi status';
                }
            };

            // Scan for WiFi networks
            window.scanWiFiNetworks = async function() {
                const scanBtn = document.getElementById('wifi-scan-btn');
                const scanText = document.getElementById('wifi-scan-text');
                const tbody = document.getElementById('wifi-networks-table');

                try {
                    const token = getToken();
                    if (!token) {
                        showToast('Please login first', 'error');
                        return;
                    }

                    // Disable button and show loading
                    scanBtn.disabled = true;
                    scanText.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Scanning...';

                    const response = await fetch(`${API_BASE}/wifi/scan`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) throw new Error('Failed to scan networks');

                    const data = await response.json();
                    const networks = data.networks;

                    if (networks.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-base-content/50">No networks found</td></tr>';
                        return;
                    }

                    // Sort by signal strength
                    networks.sort((a, b) => b.signal - a.signal);

                    tbody.innerHTML = networks.map(network => {
                        const securityBadge = network.security === 'Open' 
                            ? '<span class="badge badge-ghost badge-sm w-16 justify-center">Open</span>'
                            : '<span class="badge badge-primary badge-sm w-16 justify-center">Secure</span>';
                        
                        const freqBadge = network.frequency >= 5000
                            ? '<span class="badge badge-accent badge-sm w-16 justify-center">5 GHz</span>'
                            : '<span class="badge badge-info badge-sm w-16 justify-center">2.4 GHz</span>';

                        return `
                            <tr>
                                <td class="font-semibold">${network.ssid}</td>
                                <td class="text-center">${getSignalBadge(network.signal)}</td>
                                <td class="text-center">${securityBadge}</td>
                                <td class="text-center">${freqBadge}</td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-warning" onclick="showConnectModal('${network.ssid}', '${network.security}')">
                                        Connect
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');

                    showToast(`Found ${networks.length} network(s)`, 'success');
                } catch (error) {
                    console.error('WiFi scan error:', error);
                    showToast('Failed to scan networks: ' + error.message, 'error');
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-error">Error scanning networks</td></tr>';
                } finally {
                    scanBtn.disabled = false;
                    scanText.textContent = 'Scan';
                }
            };

            // Show connect modal
            window.showConnectModal = function(ssid, security) {
                const modal = document.getElementById('wifi-connect-modal');
                const ssidInput = document.getElementById('connect-ssid');
                const ssidDisplay = document.getElementById('connect-ssid-display');
                const passwordInput = document.getElementById('wifi-password');
                const errorDiv = document.getElementById('wifi-connect-error');

                ssidInput.value = ssid;
                ssidDisplay.textContent = ssid;
                passwordInput.value = '';
                errorDiv.classList.add('hidden');

                // If network is open, prefill password
                if (security === 'Open') {
                    passwordInput.value = 'no-password-required';
                    passwordInput.disabled = true;
                } else {
                    passwordInput.disabled = false;
                }

                modal.showModal();
            };

            // Toggle password visibility
            window.togglePasswordVisibility = function() {
                const passwordInput = document.getElementById('wifi-password');
                const eyeOpen = document.getElementById('eye-icon-open');
                const eyeClosed = document.getElementById('eye-icon-closed');

                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    eyeOpen.classList.add('hidden');
                    eyeClosed.classList.remove('hidden');
                } else {
                    passwordInput.type = 'password';
                    eyeOpen.classList.remove('hidden');
                    eyeClosed.classList.add('hidden');
                }
            };

            // Connect to WiFi
            document.getElementById('wifi-connect-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const ssid = document.getElementById('connect-ssid').value;
                const password = document.getElementById('wifi-password').value;
                const errorDiv = document.getElementById('wifi-connect-error');
                const errorText = document.getElementById('wifi-connect-error-text');
                const modal = document.getElementById('wifi-connect-modal');

                try {
                    const token = getToken();
                    showLoading();

                    const response = await fetch(`${API_BASE}/wifi/connect`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ ssid, password })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Connection failed');
                    }

                    modal.close();
                    showToast(`Connecting to ${ssid}... This may take a moment.`, 'success');
                    
                    // Reload status
                    setTimeout(loadWiFiStatus, 3000);
                } catch (error) {
                    console.error('WiFi connect error:', error);
                    errorText.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                } finally {
                    hideLoading();
                }
            });

            // Disconnect from WiFi
            window.disconnectWiFi = async function() {
                try {
                    const token = getToken();
                    showLoading();

                    const response = await fetch(`${API_BASE}/wifi/disconnect`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Disconnect failed');
                    }

                    showToast('Disconnected from WiFi network', 'success');
                    loadWiFiStatus();
                } catch (error) {
                    console.error('WiFi disconnect error:', error);
                    showToast('Failed to disconnect: ' + error.message, 'error');
                } finally {
                    hideLoading();
                }
            };


        })();
    </script>
</body>
</html>
